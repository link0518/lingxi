# 架构设计

版本：v1.0  
最后更新：2026-01-30

## 目标
为“灵犀”项目提供统一的架构说明，便于维护与迭代，并记录每次功能更新的变更。

## 总览
- 前端：React + Vite + Tailwind，单页应用，仿微信布局。
- 后端：Node.js + Express，REST API。
- 数据库：SQLite（`server/data/lingxi.sqlite`）。
- AI 调用：前端直连 OpenAI 兼容接口；后端仅存业务数据。

## 前端架构
- 入口与路由：`src/main.tsx`、`src/routes.tsx`
- 主要页面：`src/views/*`
  - 消息/聊天：`MessagesPage.tsx`、`ChatPage.tsx`、`ChatPane.tsx`
  - 通讯录/角色卡：`ContactsPage.tsx`、`CharactersPage.tsx`、`CharacterEditorPage.tsx`
  - 朋友圈：`MomentsPage.tsx`
  - 我的/设置/管理：`MePage.tsx`、`SettingsPage.tsx`、`AdminPage.tsx`
- API 封装：`src/lib/api.ts`
- UI 组件：`src/ui/*`

## 后端架构
- 入口：`server/index.js`
- 鉴权：`server/auth.js`（JWT）
- 数据库与建表：`server/db.js`
- 默认数据：`server/defaults.js`

## 数据库
- 位置：`server/data/lingxi.sqlite`
- 核心表：`accounts`、`users`、`characters`、`sessions`、`messages`、`memories`
- 配置/管理：`prompt_bricks`、`prompt_presets`、`affection_state`、`affection_stages`、`affection_tuning`、`invites`

## AI 调用
- 前端通过 `apiStreamChat` 直连 OpenAI 兼容接口（`/v1/chat/completions`）。
- API 配置仅保存在本地（`localStorage`），避免上传到服务端。
- 后端负责存储消息、记忆、好感度等业务数据。

## 部署与运行
- 本地开发：`npm run dev:full`
- 构建：`npm run build`
- 预览：`npm run preview`
- 后端独立启动：`npm run dev:server`

## 变更记录（必填）
> 每次新增/调整功能请在此追加条目。

- 2026-01-30
  - 初始化架构文档（v1.0）。
  - 更新默认提示词块（defaultPromptBricks），并同步已有用户的 prompt_bricks 数据。
  - 同步提示词预设（prompt_presets.bricks_json）为新的默认提示词块。
  - 好感度系统接入：规则 + 任务模型混合评分、每条消息触发、小时上限与总分上下限、后台配置同步生效。
  - 聊天 system prompt 注入好感度阶段提示词与长期记忆；每 10 条消息调用任务模型生成总结并写入数据库。
  - 短期记忆改为最近 20 轮（40 条消息）；阶段提示词由管理员统一维护并直接注入 system prompt。
  - 好感度阶段默认提示词更新为“阶段风格”文本，并已重置到数据库默认值。
  - 增加一键部署/更新脚本（scripts/deploy.sh, scripts/update.sh）。
