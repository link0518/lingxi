# 灵犀项目设计文档（完整版）

版本：v1.1

最后更新：2026-01-30

作者：自动生成（基于 README.md）

---

## 1. 项目概述

**项目名称**：灵犀（AI 伴侣）

**定位**：仿微信与“酒馆”风格的 AI 伴侣系统，提供聊天、角色卡、朋友圈、用户设定与管理面板等功能，支持长效记忆与好感度系统。

**核心体验**：

- 聊天体验接近微信（左侧会话列表 + 右侧聊天内容）
- 角色卡驱动的多角色聊天与朋友圈内容
- 提示词预设、好感度算法、长短期记忆的组合驱动 AI 对话
- 支持邀请码注册与管理员管理

---

## 2. 目标与范围

### 2.1 项目目标

- 完成一套前后端 + 数据库 + AI 调用的完整系统
- 实现微信式的 UI 结构（左栏列表 + 右栏内容）
- 实现角色卡体系、朋友圈、聊天与管理面板
- 支持双模型调用（聊天模型 + 任务模型）

### 2.2 范围内（MVP 不适用，要求完整）

- 前端：React + Vite + Tailwind
- 后端：API 服务、权限、邀请码、聊天与记忆处理
- 数据库：SQLite
- AI 调用：支持两套模型配置，支持自动拉取模型列表

### 2.3 非范围说明（需确认）

- 是否支持移动端与小程序（README 未提及）
- 是否支持多租户部署、日志审计、数据导出（README 未提及）

---

## 3. 角色与权限

### 3.1 角色

- **普通用户**：聊天、朋友圈、角色卡管理、设置、提示词预设
- **管理员**：除普通用户功能外，可进入管理面板

### 3.2 权限边界

- 管理面板仅管理员可见
- 用户数据隔离（聊天记录、记忆、设定、朋友圈等）

---

## 4. 功能需求（按模块）

### 4.1 消息（聊天）

- 左栏：会话列表
- 右栏：聊天内容
- 删除会话：删除后从角色卡再次进入视为新对话
- 支持长效记忆与短期记忆

### 4.2 通讯录（角色卡）

- 左栏：角色卡列表
- 右栏：角色卡详情
- 角色卡增删改查
- 角色卡头像上传（聊天与朋友圈展示）

### 4.3 朋友圈

- 展示所有角色卡的朋友圈
- 用户可发布朋友圈
- 支持点赞与评论（完全仿微信）

### 4.4 我的（用户设定）

- 展示用户设定
- 可修改头像、昵称、个性设定

### 4.5 设置

- 左栏设置选项，右栏设置内容
- 修改密码
- 退出登录
- 子模块：
  - 提示词预设：仿酒馆，分块加载，默认预设 + 自定义预设
  - API 设置：url / key / model，支持自动获取 model 列表
  - 管理面板（仅管理员）：
    - 邀请码生成与管理（一次性邀请码）
    - 用户管理：查看用户信息、查看用户聊天记录、修改密码
    - 好感度设定：好感度算法、阶段、阶段提示词与风格控制

---

## 5. 信息架构与导航结构

- 主导航：消息 / 通讯录 / 朋友圈 / 我的 / 设置
- 二级导航：
  - 消息：会话列表 / 当前会话
  - 通讯录：角色卡列表 / 角色卡详情 / 编辑页
  - 朋友圈：动态列表 / 发布
  - 我的：用户资料 / 编辑
  - 设置：提示词预设 / API 设置 / 管理面板

---

## 6. 核心业务流程

### 6.1 注册与登录

- 用户注册需邀请码（一次性）
- 登录后隔离数据

### 6.2 聊天与记忆

- 用户选择聊天角色卡进入会话
- 组合提示词 = 预设 + 角色卡设定 + 长效记忆 + 短期记忆 + 用户设定
- 前端直连 OpenAI 兼容接口，API 配置仅保存在本地
- 可配置双模型：
  - 聊天模型：生成回复
  - 任务模型：总结记忆、计算好感度
 - 默认单模型，双模型为可选模式

### 6.3 朋友圈

- 角色卡与用户都可发布动态
- 支持点赞与评论

### 6.4 管理面板

- 邀请码管理
- 用户管理
- 好感度配置

---

## 7. 数据模型设计（草案）

> 说明：以下为建议的数据结构，需结合现有实现调整。

### 7.1 核心实体

- users：用户
- roles：角色卡
- conversations：会话
- messages：聊天消息
- memories：记忆（长效/短期）
- prompts：提示词预设
- prompt_blocks：提示词分块
- moments：朋友圈动态
- comments：评论
- likes：点赞
- invites：邀请码
- settings：用户设置
- admin_settings：管理员设定（好感度算法、阶段）
- api_configs：API 配置

### 7.2 关键字段示例（简略）

- users(id, username, password_hash, avatar_url, nickname, profile_text, is_admin, created_at)
- roles(id, user_id, name, avatar_url, persona, greeting, tags, created_at)
- conversations(id, user_id, role_id, status, created_at)
- messages(id, conversation_id, sender, content, model, created_at)
- memories(id, user_id, role_id, type, content, created_at)
- moments(id, user_id, role_id, content, media_urls, created_at)
- invites(id, code, used_by, used_at, created_at, status)

---

## 8. AI 与提示词体系设计

### 8.1 提示词组合策略

- 基础提示词预设
- 角色卡设定（人格、背景、语气）
- 用户设定（昵称、偏好）
- 长效记忆（关键信息）
- 短期记忆（近期上下文）
- 好感度阶段提示词（影响语气/长度）

### 8.2 好感度系统

- 分阶段（5 阶段）：陌生 / 熟悉 / 亲近 / 依赖 / 亲密
- 每阶段定义：
  - 语气与用词风格
  - 回复长度控制
  - 对应提示词片段
- 更新模式：混合模式（规则驱动 + 任务模型评分）

---

## 9. 系统架构设计（建议）

### 9.1 前端

- React + Vite + Tailwind
- 页面结构：主布局 + 左右栏
- 状态管理：建议使用 Zustand/Redux（需确认）

### 9.2 后端

- Node.js + Express
- API：REST
- 权限：JWT

### 9.3 数据库

- SQLite（本地 + 数据库存储）

### 9.4 AI 服务

- OpenAI 兼容格式（前端直连）
- 默认单模型，允许双模型
- 任务模型处理：记忆提取、好感度计算
- 聊天模型输出最终回复

---

## 10. 接口设计（草案）

### 10.1 用户与鉴权

- POST /api/auth/register
- POST /api/auth/login
- POST /api/auth/logout

### 10.2 角色卡

- GET /api/roles
- POST /api/roles
- PUT /api/roles/:id
- DELETE /api/roles/:id

### 10.3 聊天

- GET /api/conversations
- POST /api/conversations
- GET /api/conversations/:id/messages
- POST /api/conversations/:id/messages

### 10.4 朋友圈

- GET /api/moments
- POST /api/moments
- POST /api/moments/:id/like
- POST /api/moments/:id/comment

### 10.5 管理面板

- GET /api/admin/invites
- POST /api/admin/invites
- GET /api/admin/users
- GET /api/admin/users/:id/messages
- PUT /api/admin/users/:id/password
- GET /api/admin/affinity
- PUT /api/admin/affinity

---

## 11. 安全与合规

- 密码必须加密存储
- 邀请码一次性使用
- 数据隔离：用户仅可访问自己的数据
- 管理功能需严格鉴权
- 前端直连时仅本地保存 API 配置，避免写入服务端

---

## 12. 性能与可用性

- 聊天消息分页与虚拟列表
- 朋友圈分页加载
- 记忆计算异步化

---

## 13. 实施计划（按聊天主线优先）

### 阶段 1：可用聊天（优先交付）

- 邀请码注册 + JWT 登录
- 角色卡最小化（创建/列表/详情）
- 会话与消息流（列表/发送/渲染）
- 前端直连 OpenAI 兼容接口（本地保存 API 配置）
- 短期记忆拼接（最近 20 轮）

### 阶段 2：记忆与提示词

- 长效记忆抽取与写入（按需触发）
- 提示词预设（默认 + 自定义 + 分块加载）
- 好感度混合更新（规则 + 任务模型）

### 阶段 3：体验完善

- 朋友圈（文字 + 头像）
- 角色卡头像上传与编辑完善

### 阶段 4：后台与系统能力

- API 设置（url/key/model 获取）
- 管理面板：邀请码管理、用户管理、好感度配置

---

## 14. 部署与运行（建议）

- 前端：Vite build + 静态部署
- 后端：Node 服务进程
- 数据库：SQLite 文件存储

---

## 15. 测试与验收标准

### 14.1 验收指标（建议）

- 功能完整：所有模块可用
- 权限正确：管理面板隔离
- AI 流程：提示词组合逻辑生效
- 数据隔离：不同用户数据不互通

### 14.2 测试建议

- 登录注册与邀请码验证
- 角色卡 CRUD
- 聊天流程与记忆生成
- 朋友圈点赞评论
- 管理面板功能

---

## 16. 里程碑（示例）

1. 前端页面结构完成
2. 后端 API 与 SQLite 建库
3. AI 调用与提示词系统
4. 管理面板功能
5. 联调与验收

---

## 17. 风险与待确认事项

- 前端直连会带来密钥暴露风险，需要明确本地存储与提示风险
- 好感度算法具体规则未定义

---

## 18. 后续补充建议

- 根据实际实现补充 ER 图与流程图
- 固化字段与接口规范（内部设计文档即可）
- 增加日志、监控与备份策略

---

**说明**：本文件基于 `README.md` 自动生成，部分内容为设计建议或待确认项。

---

## 9. 当前进度与待办

- 当前已完成
  - 前端结构与 API 调研完毕，接口清单初步与后端需求对齐
  - 已着手搭建后端框架、创建 server/db.js、uth.js、llm.js 等核心模块
  - 文档版本升级到 v1.1，记录设计概况
- 待办
  1. 重建并补全 server/index.js 的路由、鉴权、消息与上传逻辑
  2. 调整前端 piStreamChat 为前端直连 OpenAI 并新增 piMessagesAppend 写入接口
  3. 更新 package.json 以支持后端依赖和启动命令
  4. 联调前后端与 SQLite，验证消息同步与记忆体系
